// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  customer
  provider
  admin
}

enum BookingStatus {
  requested
  pending
  confirmed
  in_progress
  completed
  cancelled
  rejected
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum PriceType {
  fixed
  range
  quote
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(customer)
  name          String
  phone         String?
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  profile       Profile?
  providerInfo  ServiceProvider?
  customerBookings Booking[] @relation("CustomerBookings")
  providerBookings Booking[] @relation("ProviderBookings")
  reviewsGiven  Review[] @relation("Reviewer")
  reviewsReceived Review[] @relation("Reviewee")
  cancelledBookings Booking[] @relation("CancelledBy")

  @@map("users")
  @@index([email])
  @@index([role])
}

model Profile {
  userId          String  @id @map("user_id")
  profilePictureUrl String? @map("profile_picture_url")
  bio             String?
  city            String?
  area            String?
  address         String?
  latitude        Decimal? @db.Decimal(10, 8)
  longitude       Decimal? @db.Decimal(11, 8)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model ServiceCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  icon        String?
  parentId    String?  @map("parent_id")
  displayOrder Int     @default(0) @map("display_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  parent      ServiceCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ServiceCategory[] @relation("CategoryHierarchy")
  services    Service[]

  @@map("service_categories")
  @@index([parentId])
}

model ServiceProvider {
  userId            String            @id @map("user_id")
  verificationStatus VerificationStatus @default(pending) @map("verification_status")
  isActive          Boolean           @default(true) @map("is_active")
  serviceRadiusKm   Int               @default(10) @map("service_radius_km")
  averageRating     Decimal           @default(0.00) @db.Decimal(3, 2) @map("average_rating")
  totalReviews      Int               @default(0) @map("total_reviews")
  completedJobs     Int               @default(0) @map("completed_jobs")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  services          Service[]
  bookings          Booking[]
  availabilitySlots AvailabilitySlot[]
  blockedDates     BlockedDate[]

  @@map("service_providers")
  @@index([verificationStatus, isActive])
}

model Service {
  id          String    @id @default(uuid())
  providerId  String    @map("provider_id")
  categoryId  String    @map("category_id")
  name        String
  description String?
  priceType   PriceType @map("price_type")
  priceMin    Decimal?  @db.Decimal(10, 2) @map("price_min")
  priceMax    Decimal?  @db.Decimal(10, 2) @map("price_max")
  durationMinutes Int?   @map("duration_minutes")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  provider    ServiceProvider @relation(fields: [providerId], references: [userId], onDelete: Cascade)
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  bookings    Booking[]

  @@map("services")
  @@index([providerId])
  @@index([categoryId])
}

model Booking {
  id                  String        @id @default(uuid())
  customerId          String        @map("customer_id")
  providerId          String        @map("provider_id")
  serviceId           String        @map("service_id")
  status              BookingStatus @default(requested)
  requestedDate       DateTime      @map("requested_date") @db.Date
  requestedTime       DateTime      @map("requested_time") @db.Time
  confirmedDate       DateTime?     @map("confirmed_date") @db.Date
  confirmedTime       DateTime?     @map("confirmed_time") @db.Time
  specialInstructions String?       @map("special_instructions") @db.Text
  cancellationReason  String?       @map("cancellation_reason") @db.Text
  cancelledById       String?       @map("cancelled_by_id")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  customer            User          @relation("CustomerBookings", fields: [customerId], references: [id])
  provider            ServiceProvider @relation(fields: [providerId], references: [userId])
  service             Service       @relation(fields: [serviceId], references: [id])
  cancelledBy         User?         @relation("CancelledBy", fields: [cancelledById], references: [id])
  review              Review?

  @@map("bookings")
  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@index([requestedDate, requestedTime])
}

model Review {
  id        String   @id @default(uuid())
  bookingId String   @unique @map("booking_id")
  reviewerId String  @map("reviewer_id")
  revieweeId String  @map("reviewee_id")
  rating    Int
  comment   String?  @db.Text
  isVisible Boolean  @default(true) @map("is_visible")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  booking   Booking  @relation(fields: [bookingId], references: [id])
  reviewer  User     @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewee  User     @relation("Reviewee", fields: [revieweeId], references: [id])

  @@map("reviews")
  @@index([revieweeId])
  @@index([bookingId])
  @@check([rating >= 1, rating <= 5])
}

model AvailabilitySlot {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  dayOfWeek   Int      @map("day_of_week") // 0 = Sunday, 1 = Monday, etc.
  startTime   DateTime @map("start_time") @db.Time
  endTime     DateTime @map("end_time") @db.Time
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")

  provider    ServiceProvider @relation(fields: [providerId], references: [userId], onDelete: Cascade)

  @@map("availability_slots")
  @@index([providerId, dayOfWeek])
  @@check([dayOfWeek >= 0, dayOfWeek <= 6])
}

model BlockedDate {
  id          String   @id @default(uuid())
  providerId  String   @map("provider_id")
  blockedDate DateTime @map("blocked_date") @db.Date
  reason      String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  provider    ServiceProvider @relation(fields: [providerId], references: [userId], onDelete: Cascade)

  @@map("blocked_dates")
  @@unique([providerId, blockedDate])
  @@index([providerId, blockedDate])
}

